!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).BoardgameIO={})}(this,(function(e){"use strict";let t=(e=21)=>{let t="",n=e;for(;n--;)t+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[64*Math.random()|0];return t};var n=function(e){var t,n=e.Symbol;return"function"==typeof n?n.observable?t=n.observable:(t=n("observable"),n.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),r=function(){return Math.random().toString(36).substring(7).split("").join(".")},a={INIT:"@@redux/INIT"+r(),REPLACE:"@@redux/REPLACE"+r(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+r()}};function i(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function o(e,t,r){var s;if("function"==typeof t&&"function"==typeof r||"function"==typeof r&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof t&&void 0===r&&(r=t,t=void 0),void 0!==r){if("function"!=typeof r)throw new Error("Expected the enhancer to be a function.");return r(o)(e,t)}if("function"!=typeof e)throw new Error("Expected the reducer to be a function.");var u=e,c=t,l=[],p=l,f=!1;function d(){p===l&&(p=l.slice())}function h(){if(f)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return c}function y(e){if("function"!=typeof e)throw new Error("Expected the listener to be a function.");if(f)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");var t=!0;return d(),p.push(e),function(){if(t){if(f)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");t=!1,d();var n=p.indexOf(e);p.splice(n,1)}}}function v(e){if(!i(e))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(f)throw new Error("Reducers may not dispatch actions.");try{f=!0,c=u(c,e)}finally{f=!1}for(var t=l=p,n=0;n<t.length;n++){(0,t[n])()}return e}function g(e){if("function"!=typeof e)throw new Error("Expected the nextReducer to be a function.");u=e,v({type:a.REPLACE})}function m(){var e,t=y;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function n(){e.next&&e.next(h())}return n(),{unsubscribe:t(n)}}})[n]=function(){return this},e}return v({type:a.INIT}),(s={dispatch:v,subscribe:y,getState:h,replaceReducer:g})[n]=m,s}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e,t){var n=Object.keys(e);return Object.getOwnPropertySymbols&&n.push.apply(n,Object.getOwnPropertySymbols(e)),t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(n,!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}const p=(e,t,n,r)=>({type:"GAME_EVENT",payload:{type:e,args:t,playerID:n,credentials:r}}),f=(e,t,n,r)=>({type:"GAME_EVENT",payload:{type:e,args:t,playerID:n,credentials:r},automatic:!0}),d=e=>({type:"RESET",state:e,clientOnly:!0}),h=(e,t)=>({type:"UNDO",payload:{type:null,args:null,playerID:e,credentials:t}}),y=(e,t)=>({type:"REDO",payload:{type:null,args:null,playerID:e,credentials:t}}),v=()=>({type:"STRIP_TRANSIENTS"});var g=Object.freeze({makeMove:(e,t,n,r)=>({type:"MAKE_MOVE",payload:{type:e,args:t,playerID:n,credentials:r}}),gameEvent:p,automaticGameEvent:f,sync:e=>({type:"SYNC",state:e.state,log:e.log,initialState:e.initialState,clientOnly:!0}),patch:(e,t,n,r)=>({type:"PATCH",prevStateID:e,stateID:t,patch:n,deltalog:r,clientOnly:!0}),update:(e,t)=>({type:"UPDATE",state:e,deltalog:t,clientOnly:!0}),reset:d,undo:h,redo:y,plugin:(e,t,n,r)=>({type:"PLUGIN",payload:{type:e,args:t,playerID:n,credentials:r}}),stripTransients:v});function m(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+e+(n.length?" "+n.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function b(e){return!!e&&!!e[ae]}function P(e){return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);return!t||t===Object.prototype}(e)||Array.isArray(e)||!!e[re]||!!e.constructor[re]||D(e)||_(e))}function O(e,t,n){void 0===n&&(n=!1),0===w(e)?(n?Object.keys:ie)(e).forEach((function(r){n&&"symbol"==typeof r||t(r,e[r],e)})):e.forEach((function(n,r){return t(r,n,e)}))}function w(e){var t=e[ae];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:D(e)?2:_(e)?3:0}function x(e,t){return 2===w(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function I(e,t,n){var r=w(e);2===r?e.set(t,n):3===r?(e.delete(t),e.add(n)):e[t]=n}function D(e){return Z&&e instanceof Map}function _(e){return ee&&e instanceof Set}function S(e){return e.o||e.t}function E(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=oe(e);delete t[ae];for(var n=ie(t),r=0;r<n.length;r++){var a=n[r],i=t[a];!1===i.writable&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(t[a]={configurable:!0,writable:!0,enumerable:i.enumerable,value:e[a]})}return Object.create(Object.getPrototypeOf(e),t)}function A(e,t){return void 0===t&&(t=!1),j(e)||b(e)||!P(e)||(w(e)>1&&(e.set=e.add=e.clear=e.delete=M),Object.freeze(e),t&&O(e,(function(e,t){return A(t,!0)}),!0)),e}function M(){m(2)}function j(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function N(e){var t=se[e];return t||m(18,e),t}function T(){return X}function G(e,t){t&&(N("Patches"),e.u=[],e.s=[],e.v=t)}function k(e){C(e),e.p.forEach($),e.p=null}function C(e){e===X&&(X=e.l)}function L(e){return X={p:[],l:X,h:e,m:!0,_:0}}function $(e){var t=e[ae];0===t.i||1===t.i?t.j():t.g=!0}function R(e,t){t._=t.p.length;var n=t.p[0],r=void 0!==e&&e!==n;return t.h.O||N("ES5").S(t,e,r),r?(n[ae].P&&(k(t),m(4)),P(e)&&(e=U(t,e),t.l||F(t,e)),t.u&&N("Patches").M(n[ae],e,t.u,t.s)):e=U(t,n,[]),k(t),t.u&&t.v(t.u,t.s),e!==ne?e:void 0}function U(e,t,n){if(j(t))return t;var r=t[ae];if(!r)return O(t,(function(a,i){return V(e,r,t,a,i,n)}),!0),t;if(r.A!==e)return t;if(!r.P)return F(e,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var a=4===r.i||5===r.i?r.o=E(r.k):r.o;O(3===r.i?new Set(a):a,(function(t,i){return V(e,r,a,t,i,n)})),F(e,a,!1),n&&e.u&&N("Patches").R(r,n,e.u,e.s)}return r.o}function V(e,t,n,r,a,i){if(b(a)){var o=U(e,a,i&&t&&3!==t.i&&!x(t.D,r)?i.concat(r):void 0);if(I(n,r,o),!b(o))return;e.m=!1}if(P(a)&&!j(a)){if(!e.h.N&&e._<1)return;U(e,a),t&&t.A.l||F(e,a)}}function F(e,t,n){void 0===n&&(n=!1),e.h.N&&e.m&&A(t,n)}function J(e,t){var n=e[ae];return(n?S(n):e)[t]}function B(e,t){if(t in e)for(var n=Object.getPrototypeOf(e);n;){var r=Object.getOwnPropertyDescriptor(n,t);if(r)return r;n=Object.getPrototypeOf(n)}}function K(e){e.P||(e.P=!0,e.l&&K(e.l))}function z(e){e.o||(e.o=E(e.t))}function W(e,t,n){var r=D(t)?N("MapSet").T(t,n):_(t)?N("MapSet").F(t,n):e.O?function(e,t){var n=Array.isArray(e),r={i:n?1:0,A:t?t.A:T(),P:!1,I:!1,D:{},l:t,t:e,k:null,o:null,j:null,C:!1},a=r,i=ue;n&&(a=[r],i=ce);var o=Proxy.revocable(a,i),s=o.revoke,u=o.proxy;return r.k=u,r.j=s,u}(t,n):N("ES5").J(t,n);return(n?n.A:T()).p.push(r),r}function q(e){return b(e)||m(22,e),function e(t){if(!P(t))return t;var n,r=t[ae],a=w(t);if(r){if(!r.P&&(r.i<4||!N("ES5").K(r)))return r.t;r.I=!0,n=H(t,a),r.I=!1}else n=H(t,a);return O(n,(function(t,a){r&&function(e,t){return 2===w(e)?e.get(t):e[t]}(r.t,t)===a||I(n,t,e(a))})),3===a?new Set(n):n}(e)}function H(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return E(e)}var Y,X,Q="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),Z="undefined"!=typeof Map,ee="undefined"!=typeof Set,te="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,ne=Q?Symbol.for("immer-nothing"):((Y={})["immer-nothing"]=!0,Y),re=Q?Symbol.for("immer-draftable"):"__$immer_draftable",ae=Q?Symbol.for("immer-state"):"__$immer_state",ie="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,oe=Object.getOwnPropertyDescriptors||function(e){var t={};return ie(e).forEach((function(n){t[n]=Object.getOwnPropertyDescriptor(e,n)})),t},se={},ue={get:function(e,t){if(t===ae)return e;var n=S(e);if(!x(n,t))return function(e,t,n){var r,a=B(t,n);return a?"value"in a?a.value:null===(r=a.get)||void 0===r?void 0:r.call(e.k):void 0}(e,n,t);var r=n[t];return e.I||!P(r)?r:r===J(e.t,t)?(z(e),e.o[t]=W(e.A.h,r,e)):r},has:function(e,t){return t in S(e)},ownKeys:function(e){return Reflect.ownKeys(S(e))},set:function(e,t,n){var r=B(S(e),t);if(null==r?void 0:r.set)return r.set.call(e.k,n),!0;if(!e.P){var a=J(S(e),t),i=null==a?void 0:a[ae];if(i&&i.t===n)return e.o[t]=n,e.D[t]=!1,!0;if(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(n,a)&&(void 0!==n||x(e.t,t)))return!0;z(e),K(e)}return e.o[t]=n,e.D[t]=!0,!0},deleteProperty:function(e,t){return void 0!==J(e.t,t)||t in e.t?(e.D[t]=!1,z(e),K(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var n=S(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:r.enumerable,value:n[t]}:r},defineProperty:function(){m(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){m(12)}},ce={};O(ue,(function(e,t){ce[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),ce.deleteProperty=function(e,t){return ue.deleteProperty.call(this,e[0],t)},ce.set=function(e,t,n){return ue.set.call(this,e[0],t,n,e[0])};var le=new(function(){function e(e){this.O=te,this.N=!0,"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze),this.produce=this.produce.bind(this),this.produceWithPatches=this.produceWithPatches.bind(this)}var t=e.prototype;return t.produce=function(e,t,n){if("function"==typeof e&&"function"!=typeof t){var r=t;t=e;var a=this;return function(e){var n=this;void 0===e&&(e=r);for(var i=arguments.length,o=Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];return a.produce(e,(function(e){var r;return(r=t).call.apply(r,[n,e].concat(o))}))}}var i;if("function"!=typeof t&&m(6),void 0!==n&&"function"!=typeof n&&m(7),P(e)){var o=L(this),s=W(this,e,void 0),u=!0;try{i=t(s),u=!1}finally{u?k(o):C(o)}return"undefined"!=typeof Promise&&i instanceof Promise?i.then((function(e){return G(o,n),R(e,o)}),(function(e){throw k(o),e})):(G(o,n),R(i,o))}if(!e||"object"!=typeof e){if((i=t(e))===ne)return;return void 0===i&&(i=e),this.N&&A(i,!0),i}m(21,e)},t.produceWithPatches=function(e,t){var n,r,a=this;return"function"==typeof e?function(t){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return a.produceWithPatches(t,(function(t){return e.apply(void 0,[t].concat(r))}))}:[this.produce(e,t,(function(e,t){n=e,r=t})),n,r]},t.createDraft=function(e){P(e)||m(8),b(e)&&(e=q(e));var t=L(this),n=W(this,e,void 0);return n[ae].C=!0,C(t),n},t.finishDraft=function(e,t){var n=(e&&e[ae]).A;return G(n,t),R(void 0,n)},t.setAutoFreeze=function(e){this.N=e},t.setUseProxies=function(e){e&&!te&&m(20),this.O=e},t.applyPatches=function(e,t){var n;for(n=t.length-1;n>=0;n--){var r=t[n];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}var a=N("Patches").$;return b(e)?a(e,t):this.produce(e,(function(e){return a(e,t.slice(n+1))}))},e}()),pe=le.produce;le.produceWithPatches.bind(le),le.setAutoFreeze.bind(le),le.setUseProxies.bind(le),le.applyPatches.bind(le),le.createDraft.bind(le),le.finishDraft.bind(le);const fe={name:"plugin-immer",fnWrap:e=>(t,n,...r)=>{let a=!1;const i=pe(t,t=>{const i=e(t,n,...r);if("INVALID_MOVE"!==i)return i;a=!0});return a?"INVALID_MOVE":i}};class de{constructor(e){const t=function(){let e=4022871197;return function(t){const n=t.toString();for(let t=0;t<n.length;t++){e+=n.charCodeAt(t);let r=.02519603282416938*e;e=r>>>0,r-=e,r*=e,e=r>>>0,r-=e,e+=4294967296*r}return 2.3283064365386963e-10*(e>>>0)}}();this.c=1,this.s0=t(" "),this.s1=t(" "),this.s2=t(" "),this.s0-=t(e),this.s0<0&&(this.s0+=1),this.s1-=t(e),this.s1<0&&(this.s1+=1),this.s2-=t(e),this.s2<0&&(this.s2+=1)}next(){const e=2091639*this.s0+2.3283064365386963e-10*this.c;return this.s0=this.s1,this.s1=this.s2,this.s2=e-(this.c=Math.trunc(e))}}function he(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}class ye{constructor(e){this.state=e||{seed:"0"},this.used=!1}static seed(){return Date.now().toString(36).slice(-10)}isUsed(){return this.used}getState(){return this.state}_random(){this.used=!0;const e=this.state,t=function(e,t){const n=new de(e),r=n.next.bind(n);return t&&he(t,n),r.state=()=>he(n,{}),r}(e.prngstate?"":e.seed,e.prngstate),n=t();return this.state={...e,prngstate:t.state()},n}api(){const e=this._random.bind(this),t={D4:4,D6:6,D8:8,D10:10,D12:12,D20:20},n={};for(const r in t){const a=t[r];n[r]=t=>void 0===t?Math.floor(e()*a)+1:[...new Array(t).keys()].map(()=>Math.floor(e()*a)+1)}return{...n,Die:function(t=6,n){return void 0===n?Math.floor(e()*t)+1:[...new Array(n).keys()].map(()=>Math.floor(e()*t)+1)},Number:()=>e(),Shuffle:t=>{const n=t.slice(0);let r=t.length,a=0;const i=new Array(r);for(;r;){const t=Math.trunc(r*e());i[a++]=n[t],n[t]=n[--r]}return i},_obj:this}}}const ve={name:"random",noClient:({api:e})=>e._obj.isUsed(),flush:({api:e})=>e._obj.getState(),api:({data:e})=>new ye(e).api(),setup:({game:e})=>{let{seed:t}=e;return void 0===t&&(t=ye.seed()),{seed:t}},playerView:()=>{}};class ge{constructor(e,t){this.flow=e,this.playerID=t,this.dispatch=[]}api(e){const t={_obj:this},{phase:n,turn:r}=e;for(const e of this.flow.eventNames)t[e]=(...t)=>{this.dispatch.push({key:e,args:t,phase:n,turn:r})};return t}isUsed(){return this.dispatch.length>0}update(e){for(let t=0;t<this.dispatch.length;t++){const n=this.dispatch[t];if("endTurn"===n.key&&n.turn!==e.ctx.turn)continue;if(("endPhase"===n.key||"setPhase"===n.key)&&n.phase!==e.ctx.phase)continue;const r=f(n.key,n.args,this.playerID);e={...e,...this.flow.processEvent(e,r)}}return e}}const me={name:"events",noClient:({api:e})=>e._obj.isUsed(),dangerouslyFlushRawState:({state:e,api:t})=>t._obj.update(e),api:({game:e,playerID:t,ctx:n})=>new ge(e.flow,t).api(n)};var be,Pe,Oe=Function.prototype,we=Object.prototype,xe=Oe.toString,Ie=we.hasOwnProperty,De=xe.call(Object),_e=we.toString,Se=(be=Object.getPrototypeOf,Pe=Object,function(e){return be(Pe(e))});var Ee=function(e){if(!function(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=_e.call(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=Se(e);if(null===t)return!0;var n=Ie.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&xe.call(n)==De};const Ae=[fe,ve,{name:"log",flush:()=>({}),api:({data:e})=>({setMetadata:t=>{e.metadata=t}}),setup:()=>({})},{name:"plugin-serializable",fnWrap:e=>(t,n,...r)=>{const a=e(t,n,...r);if(!function e(t){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t)return!0;if(!Ee(t)&&!Array.isArray(t))return!1;for(const n in t)if(!e(t[n]))return!1;return!0}(a))throw new Error("Move state is not JSON-serialiazable.\nSee https://boardgame.io/documentation/#/?id=state for more information.");return a}}],Me=[...Ae,me],je=e=>{const t={...e.ctx},n=e.plugins||{};return Object.entries(n).forEach(([e,{api:n}])=>{t[e]=n}),t},Ne=(e,t)=>[...Me,...t].filter(e=>void 0!==e.fnWrap).reduce((e,{fnWrap:t})=>t(e),e),Te=(e,t)=>([...Me,...t.game.plugins].filter(e=>void 0!==e.api).forEach(n=>{const r=n.name,a=e.plugins[r]||{data:{}},i=n.api({G:e.G,ctx:e.ctx,data:a.data,game:t.game,playerID:t.playerID});e={...e,plugins:{...e.plugins,[r]:{...a,api:i}}}}),e),Ge=(e,t)=>([...Ae,...t.game.plugins,me].reverse().forEach(n=>{const r=n.name,a=e.plugins[r]||{data:{}};if(n.flush){const r=n.flush({G:e.G,ctx:e.ctx,game:t.game,api:a.api,data:a.data});e={...e,plugins:{...e.plugins,[n.name]:{data:r}}}}else if(n.dangerouslyFlushRawState){const i=(e=n.dangerouslyFlushRawState({state:e,game:t.game,api:a.api,data:a.data})).plugins[r].data;e={...e,plugins:{...e.plugins,[n.name]:{data:i}}}}}),e),ke=({G:e,ctx:t,plugins:n={}},{game:r,playerID:a})=>([...Me,...r.plugins].forEach(({name:i,playerView:o})=>{if(!o)return;const{data:s}=n[i]||{data:{}},u=o({G:e,ctx:t,game:r,data:s,playerID:a});n={...n,[i]:{data:u}}}),n);function Ce(e){((...e)=>{console.log(...e)})(`INFO: ${e}`)}function Le(e){((...e)=>{console.error(...e)})("ERROR:",e)}function $e(e,t,n){return{...e,ctx:Re(e.ctx,n)}}function Re(e,t){let{_prevActivePlayers:n}=e,r={},a=null,i={};if(Array.isArray(t)){const e={};t.forEach(t=>e[t]=Je.NULL),r=e}else{if(t.next&&(a=t.next),n=t.revert?n.concat({activePlayers:e.activePlayers,_activePlayersMoveLimit:e._activePlayersMoveLimit,_activePlayersNumMoves:e._activePlayersNumMoves}):[],void 0!==t.currentPlayer&&Ue(r,i,e.currentPlayer,t.currentPlayer),void 0!==t.others)for(let n=0;n<e.playOrder.length;n++){const a=e.playOrder[n];a!==e.currentPlayer&&Ue(r,i,a,t.others)}if(void 0!==t.all)for(let n=0;n<e.playOrder.length;n++){Ue(r,i,e.playOrder[n],t.all)}if(t.value)for(const e in t.value)Ue(r,i,e,t.value[e]);if(t.moveLimit)for(const e in r)void 0===i[e]&&(i[e]=t.moveLimit)}0==Object.keys(r).length&&(r=null),0==Object.keys(i).length&&(i=null);const o={};for(const e in r)o[e]=0;return{...e,activePlayers:r,_activePlayersMoveLimit:i,_activePlayersNumMoves:o,_prevActivePlayers:n,_nextActivePlayers:a}}function Ue(e,t,n,r){"object"==typeof r&&r!==Je.NULL||(r={stage:r}),void 0!==r.stage&&(e[n]=r.stage,r.moveLimit&&(t[n]=r.moveLimit))}function Ve(e,t){return e[t]+""}const Fe={first:(e,t)=>0===t.turn?t.playOrderPos:(t.playOrderPos+1)%t.playOrder.length,next:(e,t)=>(t.playOrderPos+1)%t.playOrder.length},Je={NULL:null};function Be({moves:e,phases:t,endIf:n,onEnd:r,turn:a,events:i,plugins:o}){void 0===e&&(e={}),void 0===i&&(i={}),void 0===o&&(o=[]),void 0===t&&(t={}),n||(n=()=>{}),r||(r=e=>e),a||(a={});const s={...t};""in s&&Le("cannot specify phase with empty name"),s[""]={};const u={},c=new Set;let l=null;Object.keys(e).forEach(e=>c.add(e));const f=e=>{const t=Ne(e,o);return e=>{const n=je(e);return t(e.G,n)}},d=e=>t=>{const n=je(t);return e(t.G,n)},h={onEnd:f(r),endIf:d(n)};for(const e in s){const t=s[e];if(!0===t.start&&(l=e),void 0!==t.moves)for(const n of Object.keys(t.moves))u[e+"."+n]=t.moves[n],c.add(n);void 0===t.endIf&&(t.endIf=()=>{}),void 0===t.onBegin&&(t.onBegin=e=>e),void 0===t.onEnd&&(t.onEnd=e=>e),void 0===t.turn&&(t.turn=a),void 0===t.turn.order&&(t.turn.order=Fe),void 0===t.turn.onBegin&&(t.turn.onBegin=e=>e),void 0===t.turn.onEnd&&(t.turn.onEnd=e=>e),void 0===t.turn.endIf&&(t.turn.endIf=()=>!1),void 0===t.turn.onMove&&(t.turn.onMove=e=>e),void 0===t.turn.stages&&(t.turn.stages={});for(const n in t.turn.stages){const r=t.turn.stages[n].moves||{};for(const t of Object.keys(r)){u[e+"."+n+"."+t]=r[t],c.add(t)}}t.wrapped={onBegin:f(t.onBegin),onEnd:f(t.onEnd),endIf:d(t.endIf)},t.turn.wrapped={onMove:f(t.turn.onMove),onBegin:f(t.turn.onBegin),onEnd:f(t.turn.onEnd),endIf:d(t.turn.endIf)}}function y(e){return e.phase?s[e.phase]:s[""]}function v(e){return e}function g(e,t){const n=new Set,r=new Set;for(let a=0;a<t.length;a++){const{fn:i,arg:o,...s}=t[a];if(i===E){r.clear();const t=e.ctx.phase;if(n.has(t)){const t={...e.ctx,phase:null};return{...e,ctx:t}}n.add(t)}const u=[];if(e=i(e,{...s,arg:o,next:u}),i===S)break;const c=I(e);if(c){t.push({fn:S,arg:c,turn:e.ctx.turn,phase:e.ctx.phase,automatic:!0});continue}const l=D(e);if(l)t.push({fn:E,arg:l,turn:e.ctx.turn,phase:e.ctx.phase,automatic:!0});else{if(i===v){const n=_(e);if(n){t.push({fn:A,arg:n,turn:e.ctx.turn,phase:e.ctx.phase,automatic:!0});continue}}t.push(...u)}}return e}function m(e,{next:t}){return t.push({fn:b}),e}function b(e,{next:t}){let{G:n,ctx:r}=e;return n=y(r).wrapped.onBegin(e),t.push({fn:P}),{...e,G:n,ctx:r}}function P(e,{currentPlayer:t}){let{G:n,ctx:r}=e;const a=y(r);t?(r={...r,currentPlayer:t},a.turn.activePlayers&&(r=Re(r,a.turn.activePlayers))):r=function(e,t){let{G:n,ctx:r}=e;const a=je(e),i=t.order;let o=[...new Array(r.numPlayers)].map((e,t)=>t+"");void 0!==i.playOrder&&(o=i.playOrder(n,a));const s=i.first(n,a),u=typeof s;"number"!==u&&Le(`invalid value returned by turn.order.first — expected number got ${u} “${s}”.`);const c=Ve(o,s);return r={...r,currentPlayer:c,playOrderPos:s,playOrder:o},r=Re(r,t.activePlayers||{}),r}(e,a.turn);const i=r.turn+1;return r={...r,turn:i,numMoves:0,_prevActivePlayers:[]},n=a.turn.wrapped.onBegin({...e,G:n,ctx:r}),{...e,G:n,ctx:r,_undo:[],_redo:[]}}function O(e,{arg:t,next:n,phase:r}){const a=y({phase:r});let{ctx:i}=e;if(t&&t.next){if(!(t.next in s))return Le("invalid phase: "+t.next),e;i={...i,phase:t.next}}else i=void 0!==a.next?{...i,phase:a.next}:{...i,phase:null};return e={...e,ctx:i},n.push({fn:b}),e}function w(e,{arg:t,currentPlayer:n,next:r}){let{G:a,ctx:i}=e;const o=y(i),{endPhase:s,ctx:u}=function(e,t,n,r){const a=n.order;let{G:i,ctx:o}=e,s=o.playOrderPos,u=!1;if(r&&!0!==r)"object"!=typeof r&&Le(`invalid argument to endTurn: ${r}`),Object.keys(r).forEach(e=>{switch(e){case"remove":t=Ve(o.playOrder,s);break;case"next":s=o.playOrder.indexOf(r.next),t=r.next;break;default:Le(`invalid argument to endTurn: ${e}`)}});else{const n=je(e),r=a.next(i,n),c=typeof r;void 0!==r&&"number"!==c&&Le(`invalid value returned by turn.order.next — expected number or undefined got ${c} “${r}”.`),void 0===r?u=!0:(s=r,t=Ve(o.playOrder,s))}return o={...o,playOrderPos:s,currentPlayer:t},{endPhase:u,ctx:o}}(e,n,o.turn,t);return i=u,e={...e,G:a,ctx:i},s?r.push({fn:E,turn:i.turn,phase:i.phase}):r.push({fn:P,currentPlayer:i.currentPlayer}),e}function x(e,{arg:t,playerID:n}){"string"!=typeof t&&t!==Je.NULL||(t={stage:t});let{ctx:r}=e,{activePlayers:a,_activePlayersMoveLimit:i,_activePlayersNumMoves:o}=r;return void 0!==t.stage&&(null===a&&(a={}),a[n]=t.stage,o[n]=0,t.moveLimit&&(null===i&&(i={}),i[n]=t.moveLimit)),r={...r,activePlayers:a,_activePlayersMoveLimit:i,_activePlayersNumMoves:o},{...e,ctx:r}}function I(e){return h.endIf(e)}function D(e){return y(e.ctx).wrapped.endIf(e)}function _(e){const t=y(e.ctx),n=e.ctx.numMoves||0;return!!(t.turn.moveLimit&&n>=t.turn.moveLimit)||t.turn.wrapped.endIf(e)}function S(e,{arg:t,phase:n}){e=E(e,{phase:n}),void 0===t&&(t=!0),e={...e,ctx:{...e.ctx,gameover:t}};const r=h.onEnd(e);return{...e,G:r}}function E(e,{arg:t,next:n,turn:r,automatic:a}){let i=(e=A(e,{turn:r,force:!0,automatic:!0})).G,o=e.ctx;if(n&&n.push({fn:O,arg:t,phase:o.phase}),null===o.phase)return e;i=y(o).wrapped.onEnd(e),o={...o,phase:null};const s={action:p("endPhase",t),_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase};a&&(s.automatic=!0);const u=[...e.deltalog||[],s];return{...e,G:i,ctx:o,deltalog:u}}function A(e,{arg:t,next:n,turn:r,force:a,automatic:i,playerID:o}){if(r!==e.ctx.turn)return e;let{G:s,ctx:u}=e;const c=y(u),l=u.numMoves||0;if(!a&&c.turn.moveLimit&&l<c.turn.moveLimit)return Ce(`cannot end turn before making ${c.turn.moveLimit} moves`),e;if(s=c.turn.wrapped.onEnd(e),n&&n.push({fn:w,arg:t,currentPlayer:u.currentPlayer}),u={...u,activePlayers:null},t&&t.remove){o=o||u.currentPlayer;const t=u.playOrder.filter(e=>e!=o),r=u.playOrderPos>t.length-1?0:u.playOrderPos;if(u={...u,playOrder:t,playOrderPos:r},0===t.length)return n.push({fn:E,turn:u.turn,phase:u.phase}),e}const f={action:p("endTurn",t),_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase};i&&(f.automatic=!0);const d=[...e.deltalog||[],f];return{...e,G:s,ctx:u,deltalog:d,_undo:[],_redo:[]}}function M(e,{arg:t,next:n,automatic:r,playerID:a}){a=a||e.ctx.currentPlayer;let{ctx:i}=e,{activePlayers:o,_activePlayersMoveLimit:s}=i;const u=null!==o&&a in o;if(!t&&u){const e=y(i).turn.stages[o[a]];e&&e.next&&(t=e.next)}if(n&&void 0!==t&&n.push({fn:x,arg:t,playerID:a}),!u)return e;o=Object.keys(o).filter(e=>e!==a).reduce((e,t)=>(e[t]=o[t],e),{}),s&&(s=Object.keys(s).filter(e=>e!==a).reduce((e,t)=>(e[t]=s[t],e),{})),i=function(e){let{activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:a}=e;if(t&&0==Object.keys(t).length)if(e._nextActivePlayers)e=Re(e,e._nextActivePlayers),({activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:a}=e);else if(a.length>0){const e=a.length-1;({activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r}=a[e]),a=a.slice(0,e)}else t=null,n=null;return{...e,activePlayers:t,_activePlayersMoveLimit:n,_activePlayersNumMoves:r,_prevActivePlayers:a}}({...i,activePlayers:o,_activePlayersMoveLimit:s});const c={action:p("endStage",t),_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase};r&&(c.automatic=!0);const l=[...e.deltalog||[],c];return{...e,ctx:i,deltalog:l}}function j(t,n,r){const a=y(t),i=a.turn.stages,{activePlayers:o}=t;if(o&&void 0!==o[r]&&o[r]!==Je.NULL&&void 0!==i[o[r]]&&void 0!==i[o[r]].moves){const e=i[o[r]].moves;if(n in e)return e[n]}else if(a.moves){if(n in a.moves)return a.moves[n]}else if(n in e)return e[n];return null}const N={endStage:function(e,t){return g(e,[{fn:M,playerID:t}])},setStage:function(e,t,n){return g(e,[{fn:M,arg:n,playerID:t}])},endTurn:function(e,t,n){return g(e,[{fn:A,turn:e.ctx.turn,phase:e.ctx.phase,arg:n}])},pass:function(e,t,n){return g(e,[{fn:A,turn:e.ctx.turn,phase:e.ctx.phase,force:!0,arg:n}])},endPhase:function(e){return g(e,[{fn:E,phase:e.ctx.phase,turn:e.ctx.turn}])},setPhase:function(e,t,n){return g(e,[{fn:E,phase:e.ctx.phase,turn:e.ctx.turn,arg:{next:n}}])},endGame:function(e,t,n){return g(e,[{fn:S,turn:e.ctx.turn,phase:e.ctx.phase,arg:n}])},setActivePlayers:$e},T=[];return!1!==i.endTurn&&T.push("endTurn"),!1!==i.pass&&T.push("pass"),!1!==i.endPhase&&T.push("endPhase"),!1!==i.setPhase&&T.push("setPhase"),!1!==i.endGame&&T.push("endGame"),!1!==i.setActivePlayers&&T.push("setActivePlayers"),!1!==i.endStage&&T.push("endStage"),!1!==i.setStage&&T.push("setStage"),{ctx:e=>({numPlayers:e,turn:0,currentPlayer:"0",playOrder:[...new Array(e)].map((e,t)=>t+""),playOrderPos:0,phase:l,activePlayers:null}),init:e=>g(e,[{fn:m}]),isPlayerActive:function(e,t,n){return t.activePlayers?n in t.activePlayers:t.currentPlayer===n},eventHandlers:N,eventNames:Object.keys(N),enabledEventNames:T,moveMap:u,moveNames:[...c.values()],processMove:function(e,t){const n=y(e.ctx),r=j(e.ctx,t.type,t.playerID),a=!r||"function"==typeof r||!0!==r.noLimit,{ctx:i}=e,{_activePlayersNumMoves:o}=i,{playerID:s}=t;let u=e.ctx.numMoves;a&&(s==e.ctx.currentPlayer&&u++,i.activePlayers&&o[s]++),e={...e,ctx:{...i,numMoves:u,_activePlayersNumMoves:o}},i._activePlayersMoveLimit&&o[s]>=i._activePlayersMoveLimit[s]&&(e=M(e,{playerID:s,automatic:!0}));const c=n.turn.wrapped.onMove(e);return g(e={...e,G:c},[{fn:v}])},processEvent:function(e,t){const{type:n,playerID:r,args:a}=t.payload;if(Object.prototype.hasOwnProperty.call(N,n)){const t=[e,r].concat(a);return N[n].apply({},t)}return e},getMove:j}}function Ke(e){if(function(e){return void 0!==e.processMove}(e))return e;if(void 0===e.name&&(e.name="default"),void 0===e.deltaState&&(e.deltaState=!1),void 0===e.disableUndo&&(e.disableUndo=!1),void 0===e.setup&&(e.setup=()=>({})),void 0===e.moves&&(e.moves={}),void 0===e.playerView&&(e.playerView=e=>e),void 0===e.plugins&&(e.plugins=[]),e.plugins.forEach(e=>{if(void 0===e.name)throw new Error("Plugin missing name attribute");if(e.name.includes(" "))throw new Error(e.name+": Plugin name must not include spaces")}),e.name.includes(" "))throw new Error(e.name+": Game name must not include spaces");const t=Be(e);return{...e,flow:t,moveNames:t.moveNames,pluginNames:e.plugins.map(e=>e.name),processMove:(n,r)=>{let a=t.getMove(n.ctx,r.type,r.playerID);var i;if((i=a)instanceof Object&&void 0!==i.move&&(a=a.move),a instanceof Function){const t=Ne(a,e.plugins),i={...je(n),playerID:r.playerID};let o=[];return void 0!==r.args&&(o=o.concat(r.args)),t(n.G,i,...o)}return Le(`invalid move object: ${r.type}`),n.G}}}var ze,We;!function(e){e.UnauthorizedAction="update/unauthorized_action",e.MatchNotFound="update/match_not_found",e.PatchFailed="update/patch_failed"}(ze||(ze={})),function(e){e.StaleStateId="action/stale_state_id",e.UnavailableMove="action/unavailable_move",e.InvalidMove="action/invalid_move",e.InactivePlayer="action/inactive_player",e.GameOver="action/gameover",e.ActionDisabled="action/action_disabled",e.ActionInvalid="action/action_invalid",e.PluginActionInvalid="action/plugin_invalid"}(We||(We={}));var qe="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function He(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Ye(e,t){return e(t={exports:{}},t.exports),t.exports}var Xe=Ye((function(e,t){function n(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function r(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}Object.defineProperty(t,"__esModule",{value:!0}),t.Pointer=void 0;var a=function(){function e(e){void 0===e&&(e=[""]),this.tokens=e}return e.fromJSON=function(t){var r=t.split("/").map(n);if(""!==r[0])throw new Error("Invalid JSON Pointer: "+t);return new e(r)},e.prototype.toString=function(){return this.tokens.map(r).join("/")},e.prototype.evaluate=function(e){for(var t=null,n="",r=e,a=1,i=this.tokens.length;a<i;a++)r=((t=r)||{})[n=this.tokens[a]];return{parent:t,key:n,value:r}},e.prototype.get=function(e){return this.evaluate(e).value},e.prototype.set=function(e,t){for(var n=e,r=1,a=this.tokens.length-1,i=this.tokens[r];r<a;r++)n=(n||{})[i];n&&(n[this.tokens[this.tokens.length-1]]=t)},e.prototype.push=function(e){this.tokens.push(e)},e.prototype.add=function(t){return new e(this.tokens.concat(String(t)))},e}();t.Pointer=a}));He(Xe);Xe.Pointer;var Qe=Ye((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.clone=t.objectType=t.hasOwnProperty=void 0,t.hasOwnProperty=Object.prototype.hasOwnProperty,t.objectType=function(e){return void 0===e?"undefined":null===e?"null":Array.isArray(e)?"array":typeof e},t.clone=function e(n){if(null==(r=n)||"object"!=typeof r)return n;var r;if(n.constructor==Array){for(var a=n.length,i=new Array(a),o=0;o<a;o++)i[o]=e(n[o]);return i}var s={};for(var u in n)t.hasOwnProperty.call(n,u)&&(s[u]=e(n[u]));return s}}));He(Qe);Qe.clone,Qe.objectType;var Ze=Ye((function(e,t){function n(e,t){var n={};for(var r in e)Qe.hasOwnProperty.call(e,r)&&void 0!==e[r]&&(n[r]=1);for(var a in t)Qe.hasOwnProperty.call(t,a)&&void 0!==t[a]&&delete n[a];return Object.keys(n)}function r(e){for(var t=e.length,n={},r=0;r<t;r++){var a=e[r];for(var i in a)Qe.hasOwnProperty.call(a,i)&&void 0!==a[i]&&(n[i]=(n[i]||0)+1)}for(var i in n)n[i]<t&&delete n[i];return Object.keys(n)}function a(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function i(e,t,n,r){void 0===r&&(r=s);var i={"0,0":{operations:[],cost:0}};var o=isNaN(e.length)||e.length<=0?0:e.length,u=isNaN(t.length)||t.length<=0?0:t.length;return function n(o,s){var u=o+","+s,c=i[u];if(void 0===c){if(o>0&&s>0&&!r(e[o-1],t[s-1],new Xe.Pointer).length)c=n(o-1,s-1);else{var l=[];if(o>0){var p=n(o-1,s),f={op:"remove",index:o-1};l.push(a(p,f))}if(s>0){var d=n(o,s-1),h={op:"add",index:o-1,value:t[s-1]};l.push(a(d,h))}if(o>0&&s>0){var y=n(o-1,s-1),v={op:"replace",index:o-1,original:e[o-1],value:t[s-1]};l.push(a(y,v))}c=l.sort((function(e,t){return e.cost-t.cost}))[0]}i[u]=c}return c}(o,u).operations.reduce((function(e,t){var a=e[0],i=e[1];if(function(e){return"add"===e.op}(t)){var s=t.index+1+i,u=s<o+i?String(s):"-",c={op:t.op,path:n.add(u).toString(),value:t.value};return[a.concat(c),i+1]}if(function(e){return"remove"===e.op}(t)){c={op:t.op,path:n.add(String(t.index+i)).toString()};return[a.concat(c),i-1]}var l=n.add(String(t.index+i)),p=r(t.original,t.value,l);return[a.concat.apply(a,p),i]}),[[],0])[0]}function o(e,t,a,i){void 0===i&&(i=s);var o=[];return n(e,t).forEach((function(e){o.push({op:"remove",path:a.add(e).toString()})})),n(t,e).forEach((function(e){o.push({op:"add",path:a.add(e).toString(),value:t[e]})})),r([e,t]).forEach((function(n){o.push.apply(o,i(e[n],t[n],a.add(n)))})),o}function s(e,t,n,r){if(void 0===r&&(r=s),e===t)return[];var a=Qe.objectType(e),u=Qe.objectType(t);return"array"==a&&"array"==u?i(e,t,n,r):"object"==a&&"object"==u?o(e,t,n,r):[{op:"replace",path:n.toString(),value:t}]}Object.defineProperty(t,"__esModule",{value:!0}),t.diffAny=t.diffObjects=t.diffArrays=t.intersection=t.subtract=t.isDestructive=void 0,t.isDestructive=function(e){var t=e.op;return"remove"===t||"replace"===t||"copy"===t||"move"===t},t.subtract=n,t.intersection=r,t.diffArrays=i,t.diffObjects=o,t.diffAny=s}));He(Ze);Ze.diffAny,Ze.diffObjects,Ze.diffArrays,Ze.intersection,Ze.subtract,Ze.isDestructive;var et=Ye((function(e,t){var n,r=qe&&qe.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.InvalidOperationError=t.test=t.copy=t.move=t.replace=t.remove=t.add=t.TestError=t.MissingError=void 0;var a=function(e){function t(t){var n=e.call(this,"Value required at path: "+t)||this;return n.path=t,n.name="MissingError",n}return r(t,e),t}(Error);t.MissingError=a;var i=function(e){function t(t,n){var r=e.call(this,"Test failed: "+t+" != "+n)||this;return r.actual=t,r.expected=n,r.name="TestError",r}return r(t,e),t}(Error);function o(e,t,n){if(Array.isArray(e))if("-"==t)e.push(n);else{var r=parseInt(t,10);e.splice(r,0,n)}else e[t]=n}function s(e,t){if(Array.isArray(e)){var n=parseInt(t,10);e.splice(n,1)}else delete e[t]}function u(e,t){var n=Xe.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.parent?new a(t.path):(o(n.parent,n.key,Qe.clone(t.value)),null)}function c(e,t){var n=Xe.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.value?new a(t.path):(s(n.parent,n.key),null)}function l(e,t){var n=Xe.Pointer.fromJSON(t.path).evaluate(e);if(null===n.parent)return new a(t.path);if(Array.isArray(n.parent)){if(parseInt(n.key,10)>=n.parent.length)return new a(t.path)}else if(void 0===n.value)return new a(t.path);return n.parent[n.key]=t.value,null}function p(e,t){var n=Xe.Pointer.fromJSON(t.from).evaluate(e);if(void 0===n.value)return new a(t.from);var r=Xe.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.parent?new a(t.path):(s(n.parent,n.key),o(r.parent,r.key,n.value),null)}function f(e,t){var n=Xe.Pointer.fromJSON(t.from).evaluate(e);if(void 0===n.value)return new a(t.from);var r=Xe.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.parent?new a(t.path):(o(r.parent,r.key,Qe.clone(n.value)),null)}function d(e,t){var n=Xe.Pointer.fromJSON(t.path).evaluate(e);return Ze.diffAny(n.value,t.value,new Xe.Pointer).length?new i(n.value,t.value):null}t.TestError=i,t.add=u,t.remove=c,t.replace=l,t.move=p,t.copy=f,t.test=d;var h=function(e){function t(t){var n=e.call(this,"Invalid operation: "+t.op)||this;return n.operation=t,n.name="InvalidOperationError",n}return r(t,e),t}(Error);t.InvalidOperationError=h,t.apply=function(e,t){switch(t.op){case"add":return u(e,t);case"remove":return c(e,t);case"replace":return l(e,t);case"move":return p(e,t);case"copy":return f(e,t);case"test":return d(e,t)}return new h(t)}}));He(et);et.apply,et.InvalidOperationError,et.test,et.copy,et.move,et.replace,et.remove,et.add,et.TestError,et.MissingError;var tt=Ye((function(e,t){function n(e,t){var n=Xe.Pointer.fromJSON(t).evaluate(e);if(void 0!==n)return{op:"test",path:t,value:n.value}}Object.defineProperty(t,"__esModule",{value:!0}),t.createTests=t.createPatch=t.applyPatch=void 0,t.applyPatch=function(e,t){return t.map((function(t){return et.apply(e,t)}))},t.createPatch=function(e,t,n){var r=new Xe.Pointer;return(n?function(e){return function t(n,r,a){var i=e(n,r,a);return Array.isArray(i)?i:Ze.diffAny(n,r,a,t)}}(n):Ze.diffAny)(e,t,r)},t.createTests=function(e,t){var r=new Array;return t.filter(Ze.isDestructive).forEach((function(t){var a=n(e,t.path);if(a&&r.push(a),"from"in t){var i=n(e,t.from);i&&r.push(i)}})),r}}));He(tt);tt.createTests,tt.createPatch;var nt=tt.applyPatch;const rt=e=>null!==e.payload.playerID&&void 0!==e.payload.playerID;function at(e,t){if(t.game.disableUndo)return e;const n={G:e.G,ctx:e.ctx,plugins:e.plugins,playerID:t.action.payload.playerID||e.ctx.currentPlayer};return"MAKE_MOVE"===t.action.type&&(n.moveType=t.action.payload.type),{...e,_undo:[...e._undo,n],_redo:[]}}function it(e,t,n){const r={action:t,_stateID:e._stateID,turn:e.ctx.turn,phase:e.ctx.phase},a=e.plugins.log.data.metadata;return void 0!==a&&(r.metadata=a),"object"==typeof n&&!0===n.redact&&(r.redact=!0),{...e,deltalog:[r]}}function ot(e,t,n){e=Ge(e,n);const r=(a=e,i=n,[...Me,...i.game.plugins].filter(e=>void 0!==e.isInvalid).map(e=>{const{name:t}=e,n=a.plugins[t],r=e.isInvalid({G:a.G,ctx:a.ctx,game:i.game,api:n&&n.api,data:n&&n.data});return!!r&&{plugin:t,message:r}}).find(e=>e)||!1);var a,i;if(!r)return[e];const{plugin:o,message:s}=r;return Le(`plugin declared action invalid: ${o} - ${s}`),[e,ut(t,We.PluginActionInvalid,r)]}function st(e){if(!e)return[null,void 0];const{transients:t,...n}=e;return[n,t]}function ut(e,t,n){return{...e,transients:{error:{type:t,payload:n}}}}const ct=e=>t=>n=>{const r=t(n);switch(n.type){case"STRIP_TRANSIENTS":return r;default:{const[,t]=st(e.getState());return void 0!==t?(e.dispatch({type:"STRIP_TRANSIENTS"}),{...r,transients:t}):r}}};function lt({game:e,isClient:t}){return e=Ke(e),(n=null,r)=>{let[a]=st(n);switch(r.type){case"STRIP_TRANSIENTS":return a;case"GAME_EVENT":{if(a={...a,deltalog:[]},t)return a;if(void 0!==a.ctx.gameover)return Le("cannot call event after game end"),ut(a,We.GameOver);if(rt(r)&&!e.flow.isPlayerActive(a.G,a.ctx,r.payload.playerID))return Le(`disallowed event: ${r.payload.type}`),ut(a,We.InactivePlayer);a=Te(a,{game:e,isClient:!1,playerID:r.payload.playerID});let n,i=e.flow.processEvent(a,r);return[i,n]=ot(i,a,{game:e,isClient:!1}),n?n:(i=at(i,{game:e,action:r}),{...i,_stateID:a._stateID+1})}case"MAKE_MOVE":{const n=a={...a,deltalog:[]},i=e.flow.getMove(a.ctx,r.payload.type,r.payload.playerID||a.ctx.currentPlayer);if(null===i)return Le(`disallowed move: ${r.payload.type}`),ut(a,We.UnavailableMove);if(t&&!1===i.client)return a;if(void 0!==a.ctx.gameover)return Le("cannot make move after game end"),ut(a,We.GameOver);if(rt(r)&&!e.flow.isPlayerActive(a.G,a.ctx,r.payload.playerID))return Le(`disallowed move: ${r.payload.type}`),ut(a,We.InactivePlayer);a=Te(a,{game:e,isClient:t,playerID:r.payload.playerID});const o=e.processMove(a,r.payload);if("INVALID_MOVE"===o)return Le(`invalid move: ${r.payload.type} args: ${r.payload.args}`),ut(a,We.InvalidMove);const s={...a,G:o};if(t&&((e,t)=>[...Me,...t.game.plugins].filter(e=>void 0!==e.noClient).map(n=>{const r=n.name,a=e.plugins[r];return!!a&&n.noClient({G:e.G,ctx:e.ctx,game:t.game,api:a.api,data:a.data})}).some(e=>!0===e))(s,{game:e}))return a;if(a=s,t){let t;return[a,t]=ot(a,n,{game:e,isClient:!0}),t||{...a,_stateID:a._stateID+1}}let u;return a=it(a,r,i),a=e.flow.processMove(a,r.payload),[a,u]=ot(a,n,{game:e}),u?u:(a=at(a,{game:e,action:r}),{...a,_stateID:a._stateID+1})}case"RESET":case"UPDATE":case"SYNC":return r.state;case"UNDO":{if(a={...a,deltalog:[]},e.disableUndo)return Le("Undo is not enabled"),ut(a,We.ActionDisabled);const{_undo:t,_redo:n}=a;if(t.length<2)return Le("No moves to undo"),ut(a,We.ActionInvalid);const i=t[t.length-1],o=t[t.length-2];if(rt(r)&&r.payload.playerID!==i.playerID)return Le("Cannot undo other players' moves"),ut(a,We.ActionInvalid);if(i.moveType){const t=e.flow.getMove(o.ctx,i.moveType,i.playerID);if(!((e,t,n)=>!function(e){return void 0!==e.undoable}(n)||(n.undoable instanceof Function?n.undoable(e,t):n.undoable))(a.G,a.ctx,t))return Le("Move cannot be undone"),ut(a,We.ActionInvalid)}return a=it(a,r),{...a,G:o.G,ctx:o.ctx,plugins:o.plugins,_stateID:a._stateID+1,_undo:t.slice(0,-1),_redo:[i,...n]}}case"REDO":{if(a={...a,deltalog:[]},e.disableUndo)return Le("Redo is not enabled"),ut(a,We.ActionDisabled);const{_undo:t,_redo:n}=a;if(0==n.length)return Le("No moves to redo"),ut(a,We.ActionInvalid);const i=n[0];return rt(r)&&r.payload.playerID!==i.playerID?(Le("Cannot redo other players' moves"),ut(a,We.ActionInvalid)):(a=it(a,r),{...a,G:i.G,ctx:i.ctx,plugins:i.plugins,_stateID:a._stateID+1,_undo:[...t,i],_redo:n.slice(1)})}case"PLUGIN":return((e,t,n)=>(n.game.plugins.filter(e=>void 0!==e.action).filter(e=>e.name===t.payload.type).forEach(n=>{const r=n.name,a=e.plugins[r]||{data:{}},i=n.action(a.data,t.payload);e={...e,plugins:{...e.plugins,[r]:{...a,data:i}}}}),e))(a,r,{game:e});case"PATCH":{const e=a,t=JSON.parse(JSON.stringify(e)),n=nt(t,r.patch);return n.some(e=>null!==e)?(Le(`Patch ${JSON.stringify(r.patch)} apply failed`),ut(e,ze.PatchFailed,n)):t}default:return a}}}function pt({game:e,numPlayers:t,setupData:n}){t||(t=2);let r={G:{},ctx:(e=Ke(e)).flow.ctx(t),plugins:{}};r=((e,t)=>([...Me,...t.game.plugins].filter(e=>void 0!==e.setup).forEach(n=>{const r=n.name,a=n.setup({G:e.G,ctx:e.ctx,game:t.game});e={...e,plugins:{...e.plugins,[r]:{data:a}}}}),e))(r,{game:e}),r=Te(r,{game:e,playerID:void 0});const a=je(r);r.G=e.setup(a,n);let i={...r,_undo:[],_redo:[],_stateID:0};return i=e.flow.init(i),i=Ge(i,{game:e}),e.disableUndo||(i._undo=[{G:i.G,ctx:i.ctx,plugins:i.plugins}]),i}class ft extends class{constructor({store:e,gameName:t,playerID:n,matchID:r,credentials:a,numPlayers:i}){this.store=e,this.gameName=t||"default",this.playerID=n||null,this.matchID=r||"default",this.credentials=a,this.numPlayers=i||2}}{connect(){}disconnect(){}onAction(){}onChatMessage(){}subscribe(){}subscribeChatMessage(){}subscribeMatchData(){}updateCredentials(){}updateMatchID(){}updatePlayerID(){}}const dt=e=>new ft(e);const ht=new class{constructor(){this.debugPanel=null,this.currentClient=null,this.clients=new Map,this.subscribers=new Map}register(e){this.clients.set(e,e),this.mountDebug(e),this.notifySubscribers()}unregister(e){if(this.clients.delete(e),this.currentClient===e){this.unmountDebug();for(const[e]of this.clients){if(this.debugPanel)break;this.mountDebug(e)}}this.notifySubscribers()}subscribe(e){const t=Symbol();return this.subscribers.set(t,e),e(this.getState()),()=>{this.subscribers.delete(t)}}switchPlayerID(e){if(this.currentClient.multiplayer)for(const[t]of this.clients)if(t.playerID===e&&!1!==t.debugOpt&&t.multiplayer===this.currentClient.multiplayer)return void this.switchToClient(t);this.currentClient.updatePlayerID(e),this.notifySubscribers()}switchToClient(e){e!==this.currentClient&&(this.unmountDebug(),this.mountDebug(e),this.notifySubscribers())}notifySubscribers(){const e=this.getState();this.subscribers.forEach(t=>{t(e)})}getState(){return{client:this.currentClient,debuggableClients:this.getDebuggableClients()}}getDebuggableClients(){return[...this.clients.values()].filter(e=>!1!==e.debugOpt)}mountDebug(e){if(!1===e.debugOpt||null!==this.debugPanel||"undefined"==typeof document)return;let t,n=document.body;e.debugOpt&&!0!==e.debugOpt&&(t=e.debugOpt.impl||t,n=e.debugOpt.target||n),t&&(this.currentClient=e,this.debugPanel=new t({target:n,props:{clientManager:this}}))}unmountDebug(){this.debugPanel.$destroy(),this.debugPanel=null,this.currentClient=null}};function yt(e,t,n){if(!n&&null==e){e=t.getState().ctx.currentPlayer}return e}function vt(e,t,n,r,a,i){return t.reduce((t,o)=>(t[o]=function(...t){n.dispatch(g[e](o,t,yt(r,n,i),a))},t),{})}const gt=vt.bind(null,"makeMove"),mt=vt.bind(null,"gameEvent"),bt=vt.bind(null,"plugin");class Pt{constructor({game:e,debug:n,numPlayers:r,multiplayer:a,matchID:i,playerID:s,credentials:u,enhancer:p}){this.game=Ke(e),this.playerID=s,this.matchID=i,this.credentials=u,this.multiplayer=a,this.debugOpt=n,this.manager=ht,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=lt({game:this.game,isClient:void 0!==a}),this.initialState=null,a||(this.initialState=pt({game:this.game,numPlayers:r})),this.reset=()=>{this.store.dispatch(d(this.initialState))},this.undo=()=>{const e=h(yt(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(e)},this.redo=()=>{const e=y(yt(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(e)},this.log=[];const f=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return function(){var n=e.apply(void 0,arguments),r=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},a={getState:n.getState,dispatch:function(){return r.apply(void 0,arguments)}},i=t.map((function(e){return e(a)}));return c({},n,{dispatch:r=l.apply(void 0,i)(n.dispatch)})}}}(ct,()=>e=>t=>{const n=e(t);return this.notifySubscribers(),n},e=>t=>n=>{const r=e.getState(),a=t(n);return"clientOnly"in n||"STRIP_TRANSIENTS"===n.type||this.transport.onAction(r,n),a},e=>t=>n=>{const r=t(n),a=e.getState();switch(n.type){case"MAKE_MOVE":case"GAME_EVENT":case"UNDO":case"REDO":{const e=a.deltalog;this.log=[...this.log,...e];break}case"RESET":this.log=[];break;case"PATCH":case"UPDATE":{let e=-1;this.log.length>0&&(e=this.log[this.log.length-1]._stateID);let t=n.deltalog||[];t=t.filter(t=>t._stateID>e),this.log=[...this.log,...t];break}case"SYNC":this.initialState=n.initialState,this.log=n.log||[]}return r});p=void 0!==p?l(f,p):f,this.store=o(this.reducer,this.initialState,p),a||(a=dt),this.transport=a({gameKey:e,game:this.game,store:this.store,matchID:i,playerID:s,credentials:u,gameName:this.game.name,numPlayers:r}),this.createDispatchers(),this.transport.subscribeMatchData(e=>{this.matchData=e,this.notifySubscribers()}),this.chatMessages=[],this.sendChatMessage=e=>{this.transport.onChatMessage(this.matchID,{id:t(7),sender:this.playerID,payload:e})},this.transport.subscribeChatMessage(e=>{this.chatMessages=[...this.chatMessages,e],this.notifySubscribers()})}notifySubscribers(){Object.values(this.subscribers).forEach(e=>e(this.getState()))}overrideGameState(e){this.gameStateOverride=e,this.notifySubscribers()}start(){this.transport.connect(),this._running=!0,this.manager.register(this)}stop(){this.transport.disconnect(),this._running=!1,this.manager.unregister(this)}subscribe(e){const t=Object.keys(this.subscribers).length;return this.subscribers[t]=e,this.transport.subscribe(()=>this.notifySubscribers()),!this._running&&this.multiplayer||e(this.getState()),()=>{delete this.subscribers[t]}}getInitialState(){return this.initialState}getState(){let e=this.store.getState();if(null!==this.gameStateOverride&&(e=this.gameStateOverride),null===e)return e;let t=!0;const n=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);return this.multiplayer&&!n&&(t=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||n||(t=!1),void 0!==e.ctx.gameover&&(t=!1),this.multiplayer||(e={...e,G:this.game.playerView(e.G,e.ctx,this.playerID),plugins:ke(e,this)}),{...e,log:this.log,isActive:t,isConnected:this.transport.isConnected}}createDispatchers(){this.moves=gt(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=mt(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=bt(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}updatePlayerID(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}updateMatchID(e){this.matchID=e,this.createDispatchers(),this.transport.updateMatchID(e),this.notifySubscribers()}updateCredentials(e){this.credentials=e,this.createDispatchers(),this.transport.updateCredentials(e),this.notifySubscribers()}}const Ot=(e,t)=>{if(!e||"string"!=typeof e)throw new Error(`Expected ${t} string, got "${e}".`)},wt=e=>Ot(e,"game name"),xt=e=>Ot(e,"match ID"),It=(e,t)=>{if(!e)throw new Error(`Expected body, got “${e}”.`);for(const n in t){const r=t[n],a=e[n];if(typeof a!==r)throw new TypeError(`Expected body.${n} to be of type ${r}, got “${a}”.`)}};class Dt extends Error{constructor(e,t){super(e),this.details=t}}e.Client=function(e){return new Pt(e)},e.LobbyClient=class{constructor({server:e=""}={}){this.server=e.replace(/\/$/,"")}async request(e,t){const n=await fetch(this.server+e,t);if(!n.ok){let e;try{e=await n.json()}catch(t){try{console.log(t),e=await n.text()}catch(t){e=t.message}}throw new Dt(`HTTP status ${n.status}`,e)}return n.json()}async post(e,t){let n={method:"post",body:JSON.stringify(t.body),headers:{"Content-Type":"application/json"}};return t.init&&(n={...n,...t.init,headers:{...n.headers,...t.init.headers}}),this.request(e,n)}async listGames(e){return this.request("/games",e)}async listMatches(e,t,n){wt(e);let r="";if(t){const e=[],{isGameover:n,updatedBefore:a,updatedAfter:i}=t;void 0!==n&&e.push(`isGameover=${n}`),a&&e.push(`updatedBefore=${a}`),i&&e.push(`updatedAfter=${i}`),e.length>0&&(r="?"+e.join("&"))}return this.request(`/games/${e}${r}`,n)}async getMatch(e,t,n){return wt(e),xt(t),this.request(`/games/${e}/${t}`,n)}async createMatch(e,t,n){return wt(e),It(t,{numPlayers:"number"}),this.post(`/games/${e}/create`,{body:t,init:n})}async joinMatch(e,t,n,r){return wt(e),xt(t),It(n,{playerID:"string",playerName:"string"}),this.post(`/games/${e}/${t}/join`,{body:n,init:r})}async leaveMatch(e,t,n,r){wt(e),xt(t),It(n,{playerID:"string",credentials:"string"}),await this.post(`/games/${e}/${t}/leave`,{body:n,init:r})}async updatePlayer(e,t,n,r){wt(e),xt(t),It(n,{playerID:"string",credentials:"string"}),await this.post(`/games/${e}/${t}/update`,{body:n,init:r})}async playAgain(e,t,n,r){return wt(e),xt(t),It(n,{playerID:"string",credentials:"string"}),this.post(`/games/${e}/${t}/playAgain`,{body:n,init:r})}},e.LobbyClientError=Dt,Object.defineProperty(e,"__esModule",{value:!0})}));
